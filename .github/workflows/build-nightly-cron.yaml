name: SPT-æœåŠ¡å™¨ æ¯å¤œæ„å»º
on:
#  schedule:
#    - cron: '30 2 * * *'
  #push:
  #  paths:
  #    - '.github/workflows/build-nightly-cron.yaml'
  workflow_dispatch:
env:
  SERVER_URL: https://github.com
  REPOSITORY_SPT_SERVER: sp-tarkov/server-csharp
  FIXED_COMMIT: 0df4ae717382c92f4e01f3fcc9b7ab3a27bef59f
  NIGHTLY_BRANCH: main
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      PROCEED: true  # å§‹ç»ˆæ„å»º
      CLIENT_VERSION: 4.0.2  # å¼ºåˆ¶æŒ‡å®š EFT ç‰ˆæœ¬
      SPT_VERSION: 4.0.2
      SPT_COMMIT_ID: ${{ env.FIXED_COMMIT }}
      BUILD_DATE_TIME: ${{ steps.versions.outputs.DATE_TIME }}
      BUILD_TYPE: BLEEDINGEDGEMODS
      BUILD_CONFIG: Debug
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
        id: versions
        run: |
          echo "CLIENT_VERSION=4.0.2" >> $GITHUB_OUTPUT
          echo "SPT_VERSION=4.0.2" >> $GITHUB_OUTPUT
          echo "SPT_COMMIT_ID=${{ env.FIXED_COMMIT }}" >> $GITHUB_OUTPUT
          echo "DATE_TIME=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "âœ… å°†æ„å»ºæŒ‡å®šæäº¤ï¼š${{ env.FIXED_COMMIT }}"
          echo "âœ… EFT æ¸¸æˆç‰ˆæœ¬å¼ºåˆ¶è®¾ä¸ºï¼š4.0.2"
        shell: bash

  build-server-host:
    needs: prepare
    # ç§»é™¤ if æ¡ä»¶ï¼Œå› ä¸º PROCEED æ’ä¸º true
    runs-on: ubuntu-latest
    container:
      image: refringe/spt-build-dotnet:2.0.2
    outputs:
      COMMIT_ID_LONG: ${{ env.FIXED_COMMIT }}
      COMMIT_ID_SHORT: ${{ env.FIXED_COMMIT }}
      SPT_COMMIT_TIME: ${{ steps.debug-info.outputs.SPT_COMMIT_TIME }}
      WIN_ARTIFACT: ${{ steps.filename.outputs.WIN_ARTIFACT }}
      WIN_RELEASE_FILE: ${{ steps.filename.outputs.WIN_RELEASE }}
      LINUX_ARTIFACT: ${{ steps.filename.outputs.LINUX_ARTIFACT }}
      LINUX_RELEASE_FILE: ${{ steps.filename.outputs.LINUX_RELEASE }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: å…‹éš†æŒ‡å®šç‰ˆæœ¬çš„æœåŠ¡å™¨ä»£ç 
        run: |
          git clone ${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}.git /snapshot
          cd /snapshot
          git checkout ${{ env.FIXED_COMMIT }}
          git lfs pull
      - name: è°ƒè¯•ä¿¡æ¯
        id: debug-info
        run: |
          cd /snapshot
          echo "æ­£åœ¨æ„å»ºæäº¤ï¼š$(git rev-parse HEAD)"
          echo "SPT_COMMIT_TIME=$(git log --pretty=format:"%ai" -1)" >> $GITHUB_OUTPUT
        shell: bash
      - name: æ›¿æ¢å¯åŠ¨å™¨èƒŒæ™¯å›¾
        run: |
          cp custom/bg.png /snapshot/Libraries/SPTarkov.Server.Assets/SPT_Data/images/launcher/
        shell: bash
      - name: ä¸º Windows ç‰ˆæœ¬è®¾ç½®é¡¹ç›®åç§°
        run: |
          cd /snapshot/Libraries/SPTarkov.Server.Assets/SPT_Data/configs
          git checkout core.json
          sed -i "s/\"projectName\": \"SPT\",/\"projectName\": \"AirryCo çš„ SPT Windows\",/g" core.json
        shell: bash
      - name: æ„å»º Windows æœåŠ¡å™¨
        run: |
          dotnet publish ./SPTarkov.Server/SPTarkov.Server.csproj \
            -c ${{ needs.prepare.outputs.BUILD_CONFIG }} \
            -f net9.0 \
            -r win-x64 \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:PublishSingleFile=true \
            --self-contained false \
            -p:SptBuildType=${{ needs.prepare.outputs.BUILD_TYPE }} \
            -p:SptVersion=${{ needs.prepare.outputs.SPT_VERSION }} \
            -p:SptBuildTime=$( date +%Y%m%d ) \
            -p:SptCommit=${{ env.FIXED_COMMIT }} \
            -p:IsPublish=true
        shell: bash
        working-directory: /snapshot
      - name: ä¸º Linux ç‰ˆæœ¬è®¾ç½®é¡¹ç›®åç§°
        run: |
          cd /snapshot/Libraries/SPTarkov.Server.Assets/SPT_Data/configs
          git checkout core.json
          sed -i "s/\"projectName\": \"SPT\",/\"projectName\": \"AirryCo çš„ SPT Linux\",/g" core.json
        shell: bash
      - name: æ„å»º Linux æœåŠ¡å™¨
        run: |
          dotnet publish ./SPTarkov.Server/SPTarkov.Server.csproj \
            -c ${{ needs.prepare.outputs.BUILD_CONFIG }} \
            -f net9.0 \
            -r linux-x64 \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:PublishSingleFile=true \
            --self-contained false \
            -p:SptBuildType=${{ needs.prepare.outputs.BUILD_TYPE }} \
            -p:SptVersion=${{ needs.prepare.outputs.SPT_VERSION }} \
            -p:SptBuildTime=$( date +%Y%m%d ) \
            -p:SptCommit=${{ env.FIXED_COMMIT }} \
            -p:IsPublish=true
        shell: bash
        working-directory: /snapshot
      - name: ç”Ÿæˆæ–‡ä»¶å
        id: filename
        run: |
          win_artifact_name=spt-server-${{ needs.prepare.outputs.SPT_VERSION }}-win-nightly-${{ env.FIXED_COMMIT }}-EFT${{ needs.prepare.outputs.CLIENT_VERSION }}-${{ needs.prepare.outputs.BUILD_DATE_TIME }}-artifact
          win_release_name=spt-server-${{ needs.prepare.outputs.SPT_VERSION }}-win-nightly-${{ env.FIXED_COMMIT }}-EFT${{ needs.prepare.outputs.CLIENT_VERSION }}-${{ needs.prepare.outputs.BUILD_DATE_TIME }}.zip
          linux_artifact_name=spt-server-${{ needs.prepare.outputs.SPT_VERSION }}-linux-nightly-${{ env.FIXED_COMMIT }}-EFT${{ needs.prepare.outputs.CLIENT_VERSION }}-${{ needs.prepare.outputs.BUILD_DATE_TIME }}-artifact
          linux_release_name=spt-server-${{ needs.prepare.outputs.SPT_VERSION }}-linux-nightly-${{ env.FIXED_COMMIT }}-EFT${{ needs.prepare.outputs.CLIENT_VERSION }}-${{ needs.prepare.outputs.BUILD_DATE_TIME }}.zip
          echo "WIN_ARTIFACT=$win_artifact_name" >> $GITHUB_OUTPUT
          echo "WIN_RELEASE=$win_release_name" >> $GITHUB_OUTPUT
          echo "LINUX_ARTIFACT=$linux_artifact_name" >> $GITHUB_OUTPUT
          echo "LINUX_RELEASE=$linux_release_name" >> $GITHUB_OUTPUT
        shell: bash
      - name: ä¸Šä¼  Windows æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filename.outputs.WIN_ARTIFACT }}
          path: |
            /snapshot/SPTarkov.Server/bin/${{ needs.prepare.outputs.BUILD_CONFIG }}/net9.0/win-x64/publish/
            !/snapshot/SPTarkov.Server/bin/${{ needs.prepare.outputs.BUILD_CONFIG }}/net9.0/win-x64/publish/**/*.pdb
          overwrite: true
          if-no-files-found: error
      - name: ä¸Šä¼  Linux æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filename.outputs.LINUX_ARTIFACT }}
          path: |
            /snapshot/SPTarkov.Server/bin/${{ needs.prepare.outputs.BUILD_CONFIG }}/net9.0/linux-x64/publish/
            !/snapshot/SPTarkov.Server/bin/${{ needs.prepare.outputs.BUILD_CONFIG }}/net9.0/linux-x64/publish/**/*.pdb
          overwrite: true
          if-no-files-found: error

  build-docker-image-multi-arch:
    needs: [prepare, build-server-host]
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: xxoolm
      DOCKERHUB_REPOSITORY: spt-server
      GHCR_USER: xxoolm
      GHCR_REPOSITORY: spt-server
    outputs:
      DOCKER_DIGEST_AMD64: ${{ steps.build-and-push-amd64.outputs.digest }}
      DOCKER_IMAGEID_AMD64: ${{ steps.build-and-push-amd64.outputs.imageid }}
      DOCKER_DIGEST_ARM64: ${{ steps.build-and-push-arm64.outputs.digest }}
      DOCKER_IMAGEID_ARM64: ${{ steps.build-and-push-arm64.outputs.imageid }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: æ‹‰å–æ–‡ä»¶
        run: git pull
      - name: ä¸º AMD64 æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPOSITORY }}
            ghcr.io/${{ env.GHCR_USER }}/${{ env.GHCR_REPOSITORY }}
          tags: |
            type=raw,value=nightly
      - name: ä¸º ARM64 æå– Docker å…ƒæ•°æ®
        id: meta-arm64
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPOSITORY }}
            ghcr.io/${{ env.GHCR_USER }}/${{ env.GHCR_REPOSITORY }}
          tags: |
            type=raw,value=nightly-arm64
      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: ç™»å½• DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: ç™»å½• GitHub å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ secrets.GHCR_TOKEN }}
      - name: æ„å»ºå¹¶æ¨é€ AMD64 é•œåƒ
        id: build-and-push-amd64
        uses: docker/build-push-action@v6
        with:
          context: ./docker
          file: ./docker/Dockerfile-nightly
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            ${{ steps.meta.outputs.labels }}
            org.opencontainers.image.version=${{ env.NIGHTLY_BRANCH }}
            org.opencontainers.image.revision=${{ env.FIXED_COMMIT }}
          platforms: linux/amd64
          build-args: |
            SPT_BUILD_TYPE=${{ needs.prepare.outputs.BUILD_TYPE }}
            SPT_BUILD_CONFIG=${{ needs.prepare.outputs.BUILD_CONFIG }}
            SPT_VERSION=${{ needs.prepare.outputs.SPT_VERSION }}
      - name: æ„å»ºå¹¶æ¨é€ ARM64 é•œåƒ
        id: build-and-push-arm64
        uses: docker/build-push-action@v6
        with:
          context: ./docker
          file: ./docker/Dockerfile-nightly-arm64
          push: true
          tags: ${{ steps.meta-arm64.outputs.tags }}
          labels: |
            ${{ steps.meta-arm64.outputs.labels }}
            org.opencontainers.image.version=${{ env.NIGHTLY_BRANCH }}
            org.opencontainers.image.revision=${{ env.FIXED_COMMIT }}
          platforms: linux/arm64
          build-args: |
            SPT_BUILD_TYPE=${{ needs.prepare.outputs.BUILD_TYPE }}
            SPT_BUILD_CONFIG=${{ needs.prepare.outputs.BUILD_CONFIG }}
            SPT_VERSION=${{ needs.prepare.outputs.SPT_VERSION }}

  update-trigger-and-push:
    needs: [prepare, build-server-host, build-docker-image-multi-arch]
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: æ›´æ–°è§¦å‘æ–‡ä»¶å¹¶æ¨é€
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "bot@stblog.com.cn"
          git pull
          rm -f trigger.nightly
          echo "server=${{ env.FIXED_COMMIT }}" > trigger.nightly
          git add trigger.nightly
          git commit -m "ğŸ¤– è‡ªåŠ¨æ„å»º SPT æœåŠ¡å™¨ï¼š\`${{ env.FIXED_COMMIT }}\`"
          git push
        shell: bash

  assemble-and-publish:
    needs: [prepare, build-server-host, build-docker-image-multi-arch, update-trigger-and-push]
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: ä¸‹è½½ Windows æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-server-host.outputs.WIN_ARTIFACT }}
          path: windows
      - name: ä¸‹è½½ Linux æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-server-host.outputs.LINUX_ARTIFACT }}
          path: linux
      - name: å‹ç¼©å‘å¸ƒåŒ…
        run: |
          cd windows
          zip -r ../${{ needs.build-server-host.outputs.WIN_RELEASE_FILE }} *
          cd ../linux
          zip -r ../${{ needs.build-server-host.outputs.LINUX_RELEASE_FILE }} *
        shell: bash
      - name: åˆ›å»º GitHub é¢„å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.prepare.outputs.BUILD_DATE_TIME }}
          tag_name: ${{ needs.prepare.outputs.BUILD_DATE_TIME }}
          prerelease: true
          body: |
            SPT ç‰ˆæœ¬ï¼š***${{ needs.prepare.outputs.SPT_VERSION }}***  
            Tarkov æ¸¸æˆç‰ˆæœ¬ï¼š***${{ needs.prepare.outputs.CLIENT_VERSION }}***  
            [SPT/Server](${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}) æäº¤å“ˆå¸Œï¼š[${{ env.FIXED_COMMIT }}](${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}/tree/${{ env.FIXED_COMMIT }})  
            æ„å»ºæ—¶é—´ï¼š***${{ needs.prepare.outputs.BUILD_DATE_TIME }}***  

            **æ”¯æŒ Dockerï¼ˆlinux/amd64 å’Œ linux/arm64ï¼‰**ï¼š  

            AMD64 é•œåƒï¼š  
            ```bash
            docker pull stblog/spt-server:nightly
            docker pull ghcr.io/xxoolm/spt-server:nightly
            ```

            ARM64 é•œåƒï¼š  
            ```bash
            docker pull stblog/spt-server:nightly-arm64
            docker pull ghcr.io/xxoolm/spt-server:nightly-arm64
            ```

            > [!WARNING]  
            > ä¸‹è½½åè¯·ä½¿ç”¨ WinRAR æˆ– [7-Zip](https://www.7-zip.org/) è§£å‹ï¼Œç„¶åå¤åˆ¶åˆ° Tarkov æ ¹ç›®å½•ã€‚**ä¸è¦ä½¿ç”¨ Windows èµ„æºç®¡ç†å™¨ç›´æ¥è§£å‹å’Œå¤åˆ¶æ–‡ä»¶**ã€‚  

            å®Œæ•´æ›´æ–°æ—¥å¿—ï¼š[${{ env.FIXED_COMMIT }}](${{ env.SERVER_URL }}/${{ env.REPOSITORY_SPT_SERVER }}/commit/${{ env.FIXED_COMMIT }})
          files: |
            ${{ needs.build-server-host.outputs.WIN_RELEASE_FILE }}
            ${{ needs.build-server-host.outputs.LINUX_RELEASE_FILE }}
